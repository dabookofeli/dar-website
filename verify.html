<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SV-DAR Verifier — Verify a Receipt</title>
  <meta name="description" content="Verify an SV-DAR (Self-Verifying Digital Action Receipt) locally and independently. Paste a receipt, upload a file, or enter a receipt reference to validate integrity, signature, timestamp, and optional SV-DAR guarantees." />

  <style>
    :root{
      --bg:#ffffff;
      --panel:#f7f8fa;
      --panel2:#ffffff;
      --text:#0b0f1a;
      --muted:#5b6476;
      --line:#e7eaf0;
      --accent:#0b5cff;
      --good:#1b5e20;
      --bad:#c62828;
      --warn:#8a6d00;
      --shadow: 0 10px 30px rgba(11,15,26,0.06);
      --radius:16px;
      --max:1120px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
      line-height:1.45;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:var(--max); margin:0 auto; padding:28px 18px 80px}

    /* Header */
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:16px;
      margin-bottom:16px;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .kicker{
      font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted);
    }
    h1{
      font-size:34px; margin:0;
      letter-spacing:-.02em;
    }
    .sub{
      max-width:72ch;
      color:var(--muted);
      font-size:15px;
      margin:8px 0 0;
    }
    .badges{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .badge{
      border:1px solid var(--line);
      background:var(--panel2);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      box-shadow: 0 1px 0 rgba(11,15,26,0.02);
      white-space:nowrap;
    }
    .badge strong{color:var(--text); font-weight:600}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
      margin-top:18px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .badges{justify-content:flex-start}
    }

    /* Cards */
    .card{
      background:var(--panel2);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(#fff, #fff) padding-box, linear-gradient(180deg, rgba(11,92,255,.10), rgba(11,92,255,0)) border-box;
    }
    .card .hd h2{
      margin:0;
      font-size:16px;
      letter-spacing:-.01em;
    }
    .card .hd p{
      margin:6px 0 0;
      font-size:13px;
      color:var(--muted);
      max-width:85ch;
    }
    .card .bd{padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input[type="text"], textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{
      min-height:190px;
      resize:vertical;
      font-family:var(--mono);
      font-size:12.5px;
      line-height:1.35;
    }
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:11px 12px;
      border-radius:12px;
      font-size:14px;
      cursor:pointer;
    }
    button.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
      font-weight:600;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .mini{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .toggle{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px dashed var(--line);
      border-radius:12px;
      background:var(--panel);
    }
    .toggle input{transform: translateY(1px);}
    .sep{height:1px; background:var(--line); margin:14px 0}

    /* Status / results */
    .status{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--panel);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background:var(--muted);
    }
    .status.good{background: rgba(27,94,32,.06); border-color: rgba(27,94,32,.22)}
    .status.good .dot{background:var(--good)}
    .status.bad{background: rgba(198,40,40,.06); border-color: rgba(198,40,40,.22)}
    .status.bad .dot{background:var(--bad)}
    .status.warn{background: rgba(138,109,0,.06); border-color: rgba(138,109,0,.22)}
    .status.warn .dot{background:var(--warn)}
    .status strong{font-weight:700}
    .status span{color:var(--muted); font-size:13px}

    .checks{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .check{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      background:#fff;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .check .icon{
      width:22px; height:22px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:13px;
      flex:0 0 auto;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--muted);
    }
    .check.good .icon{border-color: rgba(27,94,32,.25); background: rgba(27,94,32,.06); color:var(--good)}
    .check.bad .icon{border-color: rgba(198,40,40,.25); background: rgba(198,40,40,.06); color:var(--bad)}
    .check.warn .icon{border-color: rgba(138,109,0,.25); background: rgba(138,109,0,.06); color:var(--warn)}
    .check h3{
      margin:0;
      font-size:13px;
      letter-spacing:-.01em;
    }
    .check p{
      margin:2px 0 0;
      font-size:12.5px;
      color:var(--muted);
    }

    .monoBox{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .monoBox .bar{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:var(--panel);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .monoBox .bar .title{font-size:12px; color:var(--muted)}
    .monoBox pre{
      margin:0;
      padding:12px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* Footer sections */
    .below{
      margin-top:16px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    @media (max-width:980px){ .below{grid-template-columns:1fr} }

    .callout{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
    }
    .callout h3{margin:0; font-size:14px}
    .callout p{margin:8px 0 0; color:var(--muted); font-size:13px}
    .callout ul{margin:10px 0 0; padding-left:18px; color:var(--muted); font-size:13px}
    .callout li{margin:6px 0}
    .fineprint{
      margin-top:22px;
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Header -->
    <div class="top">
      <div class="brand">
        <div class="kicker">SV-DAR Verifier</div>
        <h1>Verify a Receipt</h1>
        <p class="sub">
          Verification starts from the receipt — not from us. Paste an SV-DAR receipt, upload a receipt file, or enter a receipt reference to validate integrity and decode the evidence.
          This page is designed to be a <strong>neutral reference verifier</strong>: it returns the same answer any conforming verifier would return.
        </p>
      </div>
      <div class="badges" aria-label="Verifier properties">
        <div class="badge"><strong>Local-first</strong> verification</div>
        <div class="badge"><strong>No accounts</strong> required</div>
        <div class="badge"><strong>No issuer</strong> access required*</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Input -->
      <section class="card" aria-label="Input">
        <div class="hd">
          <h2>1) Provide a receipt</h2>
          <p>
            An SV-DAR receipt can be verified offline from the receipt file alone. If your receipt references external artifacts (documents, policies, attachments),
            you can optionally provide them for hash matching.
          </p>
        </div>

        <div class="bd">
          <div class="row">
            <div style="min-width:260px">
              <label for="refInput">Receipt ID / Reference URL (optional)</label>
              <input id="refInput" type="text" placeholder="e.g., svdar:receipt:3p9K...  or  https://…/receipts/3p9K…" />
              <div class="hint">
                Use this only if your workflow stores receipts at a stable location. Verification should not depend on continued access to an issuer system.
              </div>
            </div>

            <div style="min-width:260px">
              <label for="fileInput">Upload receipt file (JSON)</label>
              <input id="fileInput" type="file" accept=".json,application/json" />
              <div class="hint">
                Local file verification is preferred for audits, disputes, and long-term evidence retention.
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <label for="receiptJson">Paste receipt JSON</label>
          <textarea id="receiptJson" spellcheck="false" placeholder='Paste the full SV-DAR receipt JSON here…'></textarea>

          <div class="mini">
            <div class="toggle">
              <input id="offlineMode" type="checkbox" checked />
              <label for="offlineMode" style="margin:0">Offline Mode (recommended)</label>
            </div>
            <div class="toggle">
              <input id="redactView" type="checkbox" checked />
              <label for="redactView" style="margin:0">Redact sensitive fields in display</label>
            </div>
          </div>

          <div class="actions">
            <button class="primary" id="btnVerify">Fetch &amp; Verify</button>
            <button id="btnClear">Clear</button>
            <button id="btnLoadExample">Load example</button>
          </div>

          <div class="hint">
            * “No issuer access required” means: integrity and signature checks do not require calling the issuer. If you choose to fetch a receipt by URL, your browser may make a network request.
          </div>
        </div>
      </section>

      <!-- RIGHT: Results -->
      <section class="card" aria-label="Results">
        <div class="hd">
          <h2>2) Verification result</h2>
          <p>
            SV-DAR verification is deterministic: either the receipt verifies under the stated rules, or it doesn’t. Interpretation comes <em>after</em> verification.
          </p>
        </div>

        <div class="bd">
          <div id="overallStatus" class="status warn">
            <div class="dot" aria-hidden="true"></div>
            <div>
              <strong>Ready to verify</strong>
              <span>Provide a receipt and click “Fetch &amp; Verify”.</span>
            </div>
          </div>

          <div class="checks" aria-label="Verification checks">
            <div id="chkSig" class="check">
              <div class="icon">•</div>
              <div>
                <h3>Signature</h3>
                <p>Confirms the receipt was issued by the claimed signer and has not been modified.</p>
              </div>
            </div>

            <div id="chkHash" class="check">
              <div class="icon">•</div>
              <div>
                <h3>Integrity</h3>
                <p>Recomputes hashes and confirms the receipt ID matches the canonical content.</p>
              </div>
            </div>

            <div id="chkTime" class="check">
              <div class="icon">•</div>
              <div>
                <h3>Timestamp</h3>
                <p>Validates timestamp formatting and any included time evidence (where present).</p>
              </div>
            </div>

            <div id="chkOrder" class="check">
              <div class="icon">•</div>
              <div>
                <h3>SV-DAR guarantees (optional)</h3>
                <p>Verifies optional ordering / inclusion / anchoring guarantees when provided.</p>
              </div>
            </div>
          </div>

          <div class="monoBox" aria-label="Decoded receipt summary">
            <div class="bar">
              <div class="title">Decoded summary (read-only)</div>
              <div class="title">Evidence envelope</div>
            </div>
            <pre id="decodedOut">No receipt loaded.</pre>
          </div>

          <div class="monoBox" aria-label="Verifier notes">
            <div class="bar">
              <div class="title">Verifier notes</div>
              <div class="title">What is being proven</div>
            </div>
            <pre id="notesOut">SV-DAR verification proves integrity and authorship of the receipt claims. It does not, by itself, prove that underlying real-world inputs were correct or unbiased. See “What this proves / does not prove” below.</pre>
          </div>
        </div>
      </section>
    </div>

    <!-- Below: trust framing, proves/doesn't prove, FAQ -->
    <div class="below">
      <div class="callout">
        <h3>What this proves</h3>
        <p>
          When verification succeeds, it establishes the following, independently and reproducibly:
        </p>
        <ul>
          <li><strong>Authenticity:</strong> the receipt was signed by the claimed issuer identity (public key verification).</li>
          <li><strong>Integrity:</strong> the receipt contents have not been altered since issuance (hash + signature binding).</li>
          <li><strong>Context binding:</strong> referenced artifacts (policies, documents, prompts) can be matched by hash to confirm they are exact.</li>
          <li><strong>Continuity (if present):</strong> optional SV-DAR proofs can demonstrate ordering, inclusion, and anchoring for timeline strength.</li>
        </ul>
      </div>

      <div class="callout">
        <h3>What this does not prove</h3>
        <p>
          This verifier intentionally avoids over-claiming. A verified receipt is strong evidence — but it is not a magical truth oracle.
        </p>
        <ul>
          <li><strong>Correctness of inputs:</strong> verification does not validate that source data was accurate or unbiased.</li>
          <li><strong>Human intent:</strong> verification does not prove a user’s intent, only what the system recorded and signed.</li>
          <li><strong>Fairness:</strong> verification does not certify outcomes as fair; it preserves evidence for review.</li>
          <li><strong>Completeness without proofs:</strong> if continuity proofs are absent, verification cannot prove that no events were omitted elsewhere.</li>
        </ul>
      </div>
    </div>

    <div class="below">
      <div class="callout">
        <h3>Recommended workflow (auditor / reviewer)</h3>
        <ul>
          <li>Start with the receipt file (or a stable reference) from the case record.</li>
          <li>Verify integrity and signature first. Only interpret contents after verification succeeds.</li>
          <li>If artifacts are provided (policy text, document exports), match them by hash.</li>
          <li>For timelines, verify related receipts and any ordering / anchoring evidence.</li>
          <li>Export results (verification status + decoded summary) into your workpapers.</li>
        </ul>
      </div>

      <div class="callout">
        <h3>Reference implementation</h3>
        <p>
          This page is intended as a <strong>reference verifier</strong>. Any party may implement a conforming verifier that produces the same verification result.
          Neutral verification is a core SV-DAR principle: evidence should remain verifiable even if the issuer or this website is unavailable.
        </p>
        <p class="fineprint">
          Tip: If you are embedding this verifier into enterprise workflows, keep “Offline Mode” enabled by default and avoid storing receipts server-side unless required by your retention policy.
        </p>
      </div>
    </div>

    <p class="fineprint">
      <strong>Note:</strong> This is a drop-in verifier page template with production-grade copy and UI structure.
      Connect your actual SV-DAR verification logic to the button handlers below (or replace them entirely) to perform real signature, hash, and guarantee checks.
    </p>
  </div>

  <script>
    // ---------------------------------------------------------------------
    // Drop-in wiring (UI only)
    // Replace the stub verifyReceipt() with your real SV-DAR verifier logic.
    // ---------------------------------------------------------------------

    const el = (id) => document.getElementById(id);

    const overallStatus = el("overallStatus");
    const decodedOut = el("decodedOut");
    const notesOut = el("notesOut");

    const chkSig = el("chkSig");
    const chkHash = el("chkHash");
    const chkTime = el("chkTime");
    const chkOrder = el("chkOrder");

    function setStatus(state, title, detail){
      overallStatus.classList.remove("good","bad","warn");
      overallStatus.classList.add(state);
      overallStatus.querySelector("strong").textContent = title;
      overallStatus.querySelector("span").textContent = detail;
    }

    function setCheck(card, state){
      card.classList.remove("good","bad","warn");
      if(state) card.classList.add(state);
      const icon = card.querySelector(".icon");
      icon.textContent = state === "good" ? "✓" : state === "bad" ? "!" : state === "warn" ? "…" : "•";
    }

    function redact(obj){
      // Lightweight redaction for display only (does not modify verification input)
      const SENSITIVE_KEYS = ["prompt","input","raw_input","pii","secrets","access_token","auth","authorization"];
      const deepCopy = JSON.parse(JSON.stringify(obj));
      const walk = (o) => {
        if(!o || typeof o !== "object") return;
        for(const k of Object.keys(o)){
          const v = o[k];
          if(SENSITIVE_KEYS.includes(k.toLowerCase())){
            o[k] = "[redacted]";
          } else if(typeof v === "object"){
            walk(v);
          }
        }
      };
      walk(deepCopy);
      return deepCopy;
    }

    async function verifyReceipt(receipt, options){
      // -------------------------------------------------------------------
      // STUB: Replace with real checks.
      // Expected output shape:
      // {
      //   ok: boolean,
      //   checks: { signature: "good|bad|warn", integrity: "...", timestamp: "...", guarantees: "..." },
      //   summary: { receipt_id, issuer, action_type, timestamp, policy_ref, model_ref, artifacts, related },
      //   notes: string
      // }
      // -------------------------------------------------------------------

      // Minimal heuristic placeholder to make the UX feel alive
      const hasSig = !!(receipt.signature || receipt.sig);
      const hasId  = !!(receipt.receipt_id || receipt.id);
      const hasTs  = !!(receipt.timestamp || receipt.ts);

      const checks = {
        signature: hasSig ? "warn" : "bad",
        integrity: hasId ? "warn" : "bad",
        timestamp: hasTs ? "warn" : "bad",
        guarantees: "warn"
      };

      const ok = hasSig && hasId && hasTs; // placeholder only

      return {
        ok,
        checks,
        summary: {
          receipt_id: receipt.receipt_id || receipt.id || "(missing)",
          issuer: receipt.issuer || receipt.issuer_id || "(unknown)",
          action_type: receipt.action_type || receipt.type || "(unknown)",
          timestamp: receipt.timestamp || receipt.ts || "(missing)",
          policy_ref: receipt.policy_id || receipt.policy_ref || "(optional)",
          model_ref: receipt.model || receipt.model_id || receipt.model_version || "(optional)",
          artifacts: receipt.artifacts || receipt.bindings || [],
          related: receipt.related || receipt.parents || []
        },
        notes: ok
          ? "Placeholder verification: receipt appears structurally complete. Replace this stub with real signature/hash checks."
          : "Placeholder verification failed: receipt is missing required fields. Replace this stub with real signature/hash checks."
      };
    }

    function parseJsonSafe(text){
      try { return JSON.parse(text); }
      catch(e){ return null; }
    }

    async function handleVerify(){
      const offline = el("offlineMode").checked;
      const redactView = el("redactView").checked;

      // Load receipt JSON from textarea (preferred)
      let receipt = parseJsonSafe(el("receiptJson").value.trim());

      // If not provided, attempt to use uploaded file
      if(!receipt){
        const file = el("fileInput").files?.[0];
        if(file){
          const text = await file.text();
          receipt = parseJsonSafe(text);
        }
      }

      // If still not provided, try fetch by reference URL (only if offline mode is off)
      const ref = el("refInput").value.trim();
      if(!receipt && ref){
        if(offline){
          setStatus("warn","Offline Mode enabled","Receipt fetch is disabled. Paste or upload a receipt file to verify offline.");
          return;
        }
        try{
          const res = await fetch(ref, { method: "GET" });
          const text = await res.text();
          receipt = parseJsonSafe(text);
        }catch(e){
          setStatus("bad","Unable to fetch receipt","Network fetch failed. Provide a local receipt file or paste JSON.");
          return;
        }
      }

      if(!receipt){
        setStatus("bad","No receipt found","Paste receipt JSON, upload a receipt file, or provide a fetchable reference URL.");
        return;
      }

      // Run verification (stub)
      setStatus("warn","Verifying…","Running local checks. Replace stub logic with real SV-DAR verification.");
      setCheck(chkSig, null); setCheck(chkHash, null); setCheck(chkTime, null); setCheck(chkOrder, null);

      const result = await verifyReceipt(receipt, { offline });

      // Update UI
      setCheck(chkSig,  result.checks.signature);
      setCheck(chkHash, result.checks.integrity);
      setCheck(chkTime, result.checks.timestamp);
      setCheck(chkOrder,result.checks.guarantees);

      if(result.ok){
        setStatus("good","Verified","Receipt integrity and authorship verified (placeholder).");
      }else{
        setStatus("bad","Not verified","Receipt failed verification checks (placeholder).");
      }

      const displayObj = redactView ? redact(result.summary) : result.summary;
      decodedOut.textContent = JSON.stringify(displayObj, null, 2);
      notesOut.textContent = result.notes;
    }

    function handleClear(){
      el("refInput").value = "";
      el("receiptJson").value = "";
      el("fileInput").value = "";
      decodedOut.textContent = "No receipt loaded.";
      notesOut.textContent = "SV-DAR verification proves integrity and authorship of the receipt claims. It does not, by itself, prove that underlying real-world inputs were correct or unbiased. See “What this proves / does not prove” below.";
      setStatus("warn","Ready to verify","Provide a receipt and click “Fetch & Verify”.");
      setCheck(chkSig, null); setCheck(chkHash, null); setCheck(chkTime, null); setCheck(chkOrder, null);
    }

    function loadExample(){
      const example = {
        receipt_id: "svdar:receipt:3p9KQw8mXhJ9dE2",
        issuer: "did:example:issuer-001",
        timestamp: "2026-01-18T10:00:00Z",
        action_type: "subscription.signup",
        policy_ref: "policy:v3.2.1",
        model_ref: "model:moderation:v1.8.4",
        artifacts: [
          { name: "policy_text", sha256: "8d3b…(hash)…a19f", note: "Hash-bound policy version used at decision time" },
          { name: "terms_pdf", sha256: "41c9…(hash)…0b2e", note: "Exact document snapshot referenced by hash" }
        ],
        related: [
          "svdar:receipt:prev:2mF…",
          "svdar:receipt:next:7aQ…"
        ],
        signature: "base64:MEUCIQDn…(signature)…"
      };
      el("receiptJson").value = JSON.stringify(example, null, 2);
      setStatus("warn","Example loaded","Click “Fetch & Verify” to run the (stub) checks.");
    }

    // Wire up
    el("btnVerify").addEventListener("click", handleVerify);
    el("btnClear").addEventListener("click", handleClear);
    el("btnLoadExample").addEventListener("click", loadExample);

    // Auto-load file into textarea for convenience (optional)
    el("fileInput").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      const text = await file.text();
      el("receiptJson").value = text;
      setStatus("warn","Receipt loaded from file","Click “Fetch & Verify” to verify locally.");
    });
  </script>
</body>
</html>
